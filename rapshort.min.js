var version="19-02-01",piecePawn=1,pieceKnight=2,pieceBishop=3,pieceRook=4,pieceQueen=5,pieceKing=6,colorBlack=8,colorWhite=16,colorEmpty=32,moveflagPassing=131072,moveflagCastleKing=262144,moveflagCastleQueen=524288,moveflagPromotion=15728640,moveflagPromoteQueen=1048576,moveflagPromoteRook=2097152,moveflagPromoteBishop=4194304,moveflagPromoteKnight=8388608,maskCastle=moveflagCastleKing|moveflagCastleQueen,maskColor=colorBlack|colorWhite,adjMobility=0,g_captured=0,g_castleRights=15,g_depth=0,g_passing=0,g_move50=0,g_moveNumber=0,g_pv="",g_totalNodes=0,g_startTime=0,g_inCheck=!1,g_depthout=0,g_timeout=0,g_nodeout=0,g_stop=!1,g_scoreFm="",g_lastCastle=0,undoStack=[],arrField=[],g_board=Array(256),boardCheck=Array(256),boardCastle=Array(256),whiteTurn=1,usColor=0,enColor=0,arrMaterial=[0,100,300,300,500,800,65535],arrDir=[[],[],[14,-14,18,-18,31,-31,33,-33],[15,-15,17,-17],[1,-1,16,-16],[1,-1,15,-15,16,-16,17,-17],[1,-1,15,-15,16,-16,17,-17]],arrMov=[0,0,1,7,7,7,1];function StrToSquare(a){var b={a:0,b:1,c:2,d:3,e:4,f:5,g:6,h:7}[a.charAt(0)],c=12-parseInt(a.charAt(1));return b+4|c<<4}function FormatSquare(a){return["a","b","c","d","e","f","g","h"][(15&a)-4]+(12-(a>>4))}function FormatMove(a){var b=FormatSquare(255&a)+FormatSquare(255&a>>8);return a&moveflagPromotion&&(a&moveflagPromoteQueen?b+="q":a&moveflagPromoteRook?b+="r":a&moveflagPromoteBishop?b+="b":b+="n"),b}function GetMoveFromString(a){for(var b=GenerateAllMoves(whiteTurn),c=0;c<b.length;c++)if(FormatMove(b[c])==a)return b[c]}function Initialize(){arrField=[];for(var a=0;256>a;a++)boardCheck[a]=0,boardCastle[a]=15,g_board[a]=0;for(var b=0;8>b;b++)for(var c=0;8>c;c++)arrField.push(16*(b+4)+c+4);for(var a=0;6>a;a++)boardCastle[[68,72,75,180,184,187][a]]=[7,3,11,13,12,14][a],boardCheck[[71,72,73,183,184,185][a]]=[colorBlack|moveflagCastleQueen,colorBlack|maskCastle,colorBlack|moveflagCastleKing,colorWhite|moveflagCastleQueen,colorWhite|maskCastle,colorWhite|moveflagCastleKing][a]}function InitializeFromFen(a){for(var d=0;64>d;d++)g_board[arrField[d]]=colorEmpty;a||(a="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");for(var e,f=a.split(" "),g=0,h=0,k=f[0],l=0;l<k.length;l++)if(e=k.charAt(l),"/"==e)g++,h=0;else if("0"<=e&&"9">=e)for(var m=0;m<parseInt(e);m++)h++;else{var o=e.toLowerCase(),b=o!=e,p=b?colorWhite:colorBlack,q=16*(g+4)+h+4;"p"===o?p|=piecePawn:"b"===o?p|=pieceBishop:"n"===o?p|=pieceKnight:"r"===o?p|=pieceRook:"q"===o?p|=pieceQueen:"k"===o?p|=pieceKing:void 0,g_board[q]=p,h++}whiteTurn=0|"w"==f[1].charAt(0),g_castleRights=0,-1!=f[2].indexOf("K")&&(g_castleRights|=1),-1!=f[2].indexOf("Q")&&(g_castleRights|=2),-1!=f[2].indexOf("k")&&(g_castleRights|=4),-1!=f[2].indexOf("q")&&(g_castleRights|=8),g_passing=0,-1==f[3].indexOf("-")&&(g_passing=StrToSquare(f[3])),g_move50=parseInt(f[4]),g_moveNumber=parseInt(f[5]),g_moveNumber&&g_moveNumber--,g_moveNumber*=2,whiteTurn||g_moveNumber++,undoStack=[]}function GenerateMove(a,b,c,d){adjMobility++,(7&g_board[c])==pieceKing||g_lastCastle&maskCastle&&(boardCheck[c]&g_lastCastle)==g_lastCastle?g_inCheck=!0:a[a.length]=b|c<<8|d}function GenerateAllMoves(a){g_inCheck=!1,adjMobility=0,usColor=a?colorWhite:colorBlack,enColor=a?colorBlack:colorWhite;for(var b=[],c=0;64>c;c++){var d=arrField[c],e=g_board[d];if(e&usColor)e&=7;else continue;if(adjMobility+=arrMaterial[e],1==e){var g=a?-16:16,h=d+g;g_board[h]&colorEmpty&&(GeneratePwnMoves(b,d,h,!0),!g_board[d-g-g]&&g_board[h+g]&colorEmpty&&GeneratePwnMoves(b,d,h+g,!0)),g_board[h-1]&enColor?GeneratePwnMoves(b,d,h-1,!0):h-1==g_passing?GeneratePwnMoves(b,d,g_passing,!0,moveflagPassing):g_board[h-1]&colorEmpty&&GeneratePwnMoves(b,d,h-1,!1),g_board[h+1]&enColor?GeneratePwnMoves(b,d,h+1,!0):h+1==g_passing?GeneratePwnMoves(b,d,g_passing,!0,moveflagPassing):g_board[h+1]&colorEmpty&&GeneratePwnMoves(b,d,h+1,!1)}else if(GenerateUniMoves(b,d,arrDir[e],arrMov[e]),6==e){var i=a?g_castleRights:g_castleRights>>2;1&i&&g_board[d+1]&colorEmpty&&g_board[d+2]&colorEmpty&&GenerateMove(b,d,d+2,moveflagCastleKing),2&i&&g_board[d-1]&colorEmpty&&g_board[d-2]&colorEmpty&&g_board[d-3]&colorEmpty&&GenerateMove(b,d,d-2,moveflagCastleQueen)}}return b}function GeneratePwnMoves(a,b,c,d,e){if((boardCheck[c]&g_lastCastle)==g_lastCastle&&g_lastCastle&maskCastle)g_inCheck=!0;else if(d){var f=c>>4;4==f||11==f?(GenerateMove(a,b,c,moveflagPromoteQueen),GenerateMove(a,b,c,moveflagPromoteRook),GenerateMove(a,b,c,moveflagPromoteBishop),GenerateMove(a,b,c,moveflagPromoteKnight)):GenerateMove(a,b,c,e)}}function GenerateUniMoves(a,b,d,e){for(var f=0;f<d.length;f++)for(var g=b,h=e;h--;)if(g+=d[f],g_board[g]&colorEmpty)GenerateMove(a,b,g);else if(g_board[g]&enColor){GenerateMove(a,b,g);break}else break}function MakeMove(a){var b=255&a,c=255&a>>8,d=16711680&a,e=g_board[b],f=c;g_captured=g_board[c],g_lastCastle=a&maskCastle|e&maskColor,d&moveflagCastleKing?(g_board[c-1]=g_board[c+1],g_board[c+1]=colorEmpty):d&moveflagCastleQueen?(g_board[c+1]=rook=g_board[c-2],g_board[c-2]=colorEmpty):d&moveflagPassing&&(f=whiteTurn?c+16:c-16,g_captured=g_board[f],g_board[f]=colorEmpty),undoStack.push(new cUndo),g_passing=0;var g=15&g_captured;if(g?g_move50=0:(7&(15&e))==piecePawn?(c==b+32&&(g_passing=b+16),c==b-32&&(g_passing=b-16),g_move50=0):g_move50++,d&moveflagPromotion){var h=-8&e;h|=d&moveflagPromoteKnight?pieceKnight:d&moveflagPromoteQueen?pieceQueen:d&moveflagPromoteBishop?pieceBishop:pieceRook,g_board[c]=h}else g_board[c]=g_board[b];g_board[b]=colorEmpty,g_castleRights&=boardCastle[b]&boardCastle[c],whiteTurn^=1,g_moveNumber++}function UnmakeMove(a){var b=255&a,c=255&a>>8,d=16711680&a,e=g_board[c],f=c,g=undoStack[undoStack.length-1];undoStack.pop(),g_passing=g.passing,g_castleRights=g.castle,g_move50=g.move50,g_lastCastle=g.lastCastle;var h=g.captured;d&moveflagCastleKing?(g_board[c+1]=g_board[c-1],g_board[c-1]=colorEmpty):d&moveflagCastleQueen&&(g_board[c-2]=g_board[c+1],g_board[c+1]=colorEmpty),d&moveflagPromotion?(e=-8&g_board[c]|piecePawn,g_board[b]=e):g_board[b]=g_board[c],d&moveflagPassing&&(f=whiteTurn?c-16:c+16,g_board[c]=colorEmpty),g_board[f]=h,whiteTurn^=1,g_moveNumber--}var bsIn=-1,bsFm="",bsPv="";function GetScore(a,b,c,d,e){for(var f=adjMobility,g=a.length,h=g,i=0,j="",k="";g--;){8191&++g_totalNodes||(g_stop=1<c&&(g_timeout&&Date.now()-g_startTime>g_timeout||g_nodeout&&g_totalNodes>g_nodeout));var l=a[g];MakeMove(l),g_depth=0,g_pv="";var m=GenerateAllMoves(whiteTurn),o=f-adjMobility;if(g_inCheck?(h--,o=-65535):99<g_move50?o=0:b<c&&(o=-GetScore(m,b+1,c,-e,-d)),UnmakeMove(l),g_stop)return-65535;if(d<o&&(d=o,j=FormatMove(l),k=j+" "+g_pv,i=g_depth+1,1==b)){g_scoreFm=61440<o?"mate "+(65535-o>>1):-61440>o?"mate "+(-65534-o>>1):"cp "+(o>>2),bsIn=g,bsFm=j,bsPv=k;var p=Date.now()-g_startTime,q=Math.floor(1e3*(g_totalNodes/p));postMessage("info currmove "+bsFm+" currmovenumber "+g+" nodes "+g_totalNodes+" time "+p+" nps "+q+" depth "+g_depthout+" seldepth "+i+" score "+g_scoreFm+" pv "+bsPv)}if(d>=e)break}return h||(GenerateAllMoves(1^whiteTurn),d=g_inCheck?-65535+b:0),g_depth=i,g_pv=k,d}function Search(a,b,c){var d=GenerateAllMoves(whiteTurn);g_stop=!1,g_totalNodes=0,g_depthout=a?a:1,g_timeout=b,g_nodeout=c;do{bsIn=d.length-1;var e=GetScore(d,1,g_depthout,-65535,65535);if(d.push(d.splice(bsIn,1)),g_depth<g_depthout++||-61440>e||61440<e)break}while((!a||g_depthout<a)&&!g_stop);var b=Date.now()-g_startTime,f=Math.floor(1e3*(g_totalNodes/b)),g=bsPv.split(" "),h=1<g.length?" ponder "+g[1]:"";return postMessage("info nodes "+g_totalNodes+" time "+b+" nps "+f),postMessage("bestmove "+bsFm+h),!0}var cUndo=function(){this.captured=g_captured,this.passing=g_passing,this.castle=g_castleRights,this.move50=g_move50,this.lastCastle=g_lastCastle};Initialize();function GetNumber(a,b,c){var d=b.exec(a);return d?0|d[1]:c}onmessage=function(a){/^(.*?)\n?$/.exec(a.data);var b=RegExp.$1;if("uci"==b)postMessage("id name Rapshort 19-02-01"),postMessage("id author Thibor Raven"),postMessage("uciok");else if("isready"==b)postMessage("readyok");else if(/^position (?:(startpos)|fen (.*?))\s*(?:moves\s*(.*))?$/.exec(b)){if(InitializeFromFen("startpos"==RegExp.$1?"":RegExp.$2),RegExp.$3)for(var c=RegExp.$3.split(" "),e=0;e<c.length;e++)MakeMove(GetMoveFromString(c[e]));}else if(/^go /.exec(b)){g_startTime=Date.now();var f=GetNumber(b,/movetime (\d+)/,0),g=GetNumber(b,/depth (\d+)/,0),d=GetNumber(b,/nodes (\d+)/,0);if(!f&&!g&&!d){var h=whiteTurn?GetNumber(b,/wtime (\d+)/,0):GetNumber(b,/btime (\d+)/,0),j=whiteTurn?GetNumber(b,/winc (\d+)/,0):GetNumber(b,/binc (\d+)/,0),k=GetNumber(b,/movestogo (\d+)/,32);f=Math.floor(h/k)+j-255}Search(g,f,d)}};