var version="2020-04-02",piecePawn=1,pieceKnight=2,pieceBishop=3,pieceRook=4,pieceQueen=5,pieceKing=6,colorBlack=8,colorWhite=16,colorEmpty=32,moveflagPassing=2<<16,moveflagCastleKing=4<<16,moveflagCastleQueen=8<<16,moveflagPromotion=240<<16,moveflagPromoteQueen=16<<16,moveflagPromoteRook=32<<16,moveflagPromoteBishop=64<<16,moveflagPromoteKnight=8388608,maskCastle=moveflagCastleKing|moveflagCastleQueen,maskColor=colorBlack|colorWhite,adjMobility=0,g_captured=0,g_castleRights=15,g_depth=0,g_passing=0,g_move50=0,g_moveNumber=0,g_pv="",g_totalNodes=0,g_startTime=0,g_inCheck=!1,g_timeout=0,g_nodeout=0,g_stop=!1,g_scoreFm="",g_lastCastle=0,undoStack=[],arrField=[],g_board=new Array(256),boardCheck=new Array(256),boardCastle=new Array(256),whiteTurn=1,usColor=0,enColor=0,arrMaterial=[0,100,300,300,500,800,65535],arrDir=[[],[],[14,-14,18,-18,31,-31,33,-33],[15,-15,17,-17],[1,-1,16,-16],[1,-1,15,-15,16,-16,17,-17],[1,-1,15,-15,16,-16,17,-17]],arrMov=[0,0,1,7,7,7,1];function StrToSquare(e){return"abcdefgh".indexOf(e[0])+4|12-parseInt(e[1])<<4}function FormatSquare(e){return"abcdefgh"[(15&e)-4]+(12-(e>>4))}function FormatMove(e){var o=FormatSquare(255&e)+FormatSquare(e>>8&255);return e&moveflagPromotion&&(o+=e&moveflagPromoteQueen?"q":e&moveflagPromoteRook?"r":e&moveflagPromoteBishop?"b":"n"),o}function GetMoveFromString(e){for(var o=GenerateAllMoves(whiteTurn),a=0;a<o.length;a++)if(FormatMove(o[a])==e)return o[a]}function Initialize(){arrField=[];for(var e=0;e<256;e++)boardCheck[e]=0,boardCastle[e]=15,g_board[e]=0;for(var o=0;o<8;o++)for(var a=0;a<8;a++)arrField.push(16*(o+4)+a+4);for(e=0;e<6;e++)boardCastle[[68,72,75,180,184,187][e]]=[7,3,11,13,12,14][e],boardCheck[[71,72,73,183,184,185][e]]=[colorBlack|moveflagCastleQueen,colorBlack|maskCastle,colorBlack|moveflagCastleKing,colorWhite|moveflagCastleQueen,colorWhite|maskCastle,colorWhite|moveflagCastleKing][e]}function InitializeFromFen(e){for(var o=0;o<64;o++)g_board[arrField[o]]=colorEmpty;for(var a=(e=e||"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1").split(" "),r=0,t=0,g=a[0],s=0;s<g.length;s++){var n=g.charAt(s);if("/"==n)r++,t=0;else if("0"<=n&&n<="9")t+=parseInt(n);else{var i=n.toLowerCase(),l=i!=n?colorWhite:colorBlack,m=16*(r+4)+t+4;switch(i){case"p":l|=piecePawn;break;case"b":l|=pieceBishop;break;case"n":l|=pieceKnight;break;case"r":l|=pieceRook;break;case"q":l|=pieceQueen;break;case"k":l|=pieceKing}g_board[m]=l,t++}}whiteTurn="w"==a[1].charAt(0)|0,g_castleRights=0,-1!=a[2].indexOf("K")&&(g_castleRights|=1),-1!=a[2].indexOf("Q")&&(g_castleRights|=2),-1!=a[2].indexOf("k")&&(g_castleRights|=4),-1!=a[2].indexOf("q")&&(g_castleRights|=8),g_passing=0,-1==a[3].indexOf("-")&&(g_passing=StrToSquare(a[3])),g_move50=parseInt(a[4]),(g_moveNumber=parseInt(a[5]))&&g_moveNumber--,g_moveNumber*=2,whiteTurn||g_moveNumber++,undoStack=[]}function GenerateMove(e,o,a,r){adjMobility++,(7&g_board[a])==pieceKing||g_lastCastle&maskCastle&&(boardCheck[a]&g_lastCastle)==g_lastCastle?g_inCheck=!0:e[e.length]=o|a<<8|r}function GenerateAllMoves(e){g_inCheck=!1,usColor=e?colorWhite:colorBlack,enColor=e?colorBlack:colorWhite;for(var o=[],a=adjMobility=0;a<64;a++){var r=arrField[a],t=g_board[r];if(t&usColor)if(adjMobility+=arrMaterial[t&=7],1==t){var g=e?-16:16,s=r+g;g_board[s]&colorEmpty&&(GeneratePwnMoves(o,r,s,!0),!g_board[r-g-g]&&g_board[s+g]&colorEmpty&&GeneratePwnMoves(o,r,s+g,!0)),g_board[s-1]&enColor?GeneratePwnMoves(o,r,s-1,!0):s-1==g_passing?GeneratePwnMoves(o,r,g_passing,!0,moveflagPassing):g_board[s-1]&colorEmpty&&GeneratePwnMoves(o,r,s-1,!1),g_board[s+1]&enColor?GeneratePwnMoves(o,r,s+1,!0):s+1==g_passing?GeneratePwnMoves(o,r,g_passing,!0,moveflagPassing):g_board[s+1]&colorEmpty&&GeneratePwnMoves(o,r,s+1,!1)}else if(GenerateUniMoves(o,r,arrDir[t],arrMov[t]),6==t){var n=e?g_castleRights:g_castleRights>>2;1&n&&g_board[r+1]&colorEmpty&&g_board[r+2]&colorEmpty&&GenerateMove(o,r,r+2,moveflagCastleKing),2&n&&g_board[r-1]&colorEmpty&&g_board[r-2]&colorEmpty&&g_board[r-3]&colorEmpty&&GenerateMove(o,r,r-2,moveflagCastleQueen)}}return o}function GeneratePwnMoves(e,o,a,r,t){if((boardCheck[a]&g_lastCastle)==g_lastCastle&&g_lastCastle&maskCastle)g_inCheck=!0;else if(r){var g=a>>4;4==g||11==g?(GenerateMove(e,o,a,moveflagPromoteQueen),GenerateMove(e,o,a,moveflagPromoteRook),GenerateMove(e,o,a,moveflagPromoteBishop),GenerateMove(e,o,a,moveflagPromoteKnight)):GenerateMove(e,o,a,t)}}function GenerateUniMoves(e,o,a,r){for(var t=0;t<a.length;t++)for(var g=o,s=r;s--;){if(g+=a[t],!(g_board[g]&colorEmpty)){if(g_board[g]&enColor){GenerateMove(e,o,g);break}break}GenerateMove(e,o,g)}}function MakeMove(e){var o=255&e,a=e>>8&255,r=16711680&e,t=g_board[o],g=15&t,s=a;if(g_captured=g_board[a],g_lastCastle=e&maskCastle|t&maskColor,r&moveflagCastleKing?(g_board[a-1]=g_board[1+a],g_board[1+a]=colorEmpty):r&moveflagCastleQueen?(g_board[1+a]=g_board[a-2],g_board[a-2]=colorEmpty):r&moveflagPassing&&(g_captured=g_board[s=whiteTurn?16+a:a-16],g_board[s]=colorEmpty),undoStack.push(new cUndo),g_passing=0,15&g_captured?g_move50=0:(7&g)==piecePawn?(a==32+o&&(g_passing=16+o),a==o-32&&(g_passing=o-16),g_move50=0):g_move50++,r&moveflagPromotion){var n=-8&t;n|=r&moveflagPromoteKnight?pieceKnight:r&moveflagPromoteQueen?pieceQueen:r&moveflagPromoteBishop?pieceBishop:pieceRook,g_board[a]=n}else g_board[a]=g_board[o];g_board[o]=colorEmpty,g_castleRights&=boardCastle[o]&boardCastle[a],whiteTurn^=1,g_moveNumber++}function UnmakeMove(e){var o=255&e,a=e>>8&255,r=16711680&e,t=g_board[a],g=a,s=undoStack[undoStack.length-1];undoStack.pop(),g_passing=s.passing,g_castleRights=s.castle,g_move50=s.move50,g_lastCastle=s.lastCastle;var n=s.captured;r&moveflagCastleKing?(g_board[1+a]=g_board[a-1],g_board[a-1]=colorEmpty):r&moveflagCastleQueen&&(g_board[a-2]=g_board[1+a],g_board[1+a]=colorEmpty),r&moveflagPromotion?(t=-8&g_board[a]|piecePawn,g_board[o]=t):g_board[o]=g_board[a],r&moveflagPassing&&(g=whiteTurn?a-16:16+a,g_board[a]=colorEmpty),g_board[g]=n,whiteTurn^=1,g_moveNumber--}var bsIn=-1,bsFm="",bsPv="";function GetScore(e,o,a,r,t){for(var g=adjMobility,s=e.length,n=s,i=0,l="",m="";s--;){8191&++g_totalNodes||(g_stop=1<a&&(g_timeout&&Date.now()-g_startTime>g_timeout||g_nodeout&&g_nodeout<g_totalNodes));var c=e[s];MakeMove(c),g_depth=0,g_pv="";var v=GenerateAllMoves(whiteTurn),_=g-adjMobility;if(g_inCheck?(n--,_=-65535):99<g_move50?_=0:o<a&&(_=-GetScore(v,o+1,a,-t,-r)),UnmakeMove(c),g_stop)return-65535;if(r<_&&(r=_,m=(l=FormatMove(c))+" "+g_pv,i=g_depth+1,1==o)){g_scoreFm=61440<_?"mate "+(65535-_>>1):_<-61440?"mate "+(-65534-_>>1):"cp "+(_>>2),bsIn=s,bsFm=l,bsPv=m;var d=Date.now()-g_startTime,p=Math.floor(g_totalNodes/d*1e3);postMessage("info currmove "+bsFm+" currmovenumber "+s+" nodes "+g_totalNodes+" time "+d+" nps "+p+" depth "+a+" seldepth "+i+" score "+g_scoreFm+" pv "+bsPv)}if(t<=r)break}return n||(GenerateAllMoves(1^whiteTurn),r=g_inCheck?-65535+o:0),g_depth=i,g_pv=m,r}function Search(e,o,a){var r=GenerateAllMoves(whiteTurn),t=e||1;g_stop=!1,g_totalNodes=0,g_timeout=o,g_nodeout=a;do{bsIn=r.length-1;GetScore(r,1,t++,-65535,65535);r.push(r.splice(bsIn,1))}while((!e||t<e)&&!g_stop);o=Date.now()-g_startTime;var g=Math.floor(g_totalNodes/o*1e3),s=bsPv.split(" "),n=1<s.length?" ponder "+s[1]:"";postMessage("info nodes "+g_totalNodes+" time "+o+" nps "+g),postMessage("bestmove "+bsFm+n)}var cUndo=function(){this.captured=g_captured,this.passing=g_passing,this.castle=g_castleRights,this.move50=g_move50,this.lastCastle=g_lastCastle};function GetNumber(e,o,a){var r=o.exec(e);return r?0|r[1]:a}Initialize(),onmessage=function(e){/^(.*?)\n?$/.exec(e.data);var o=RegExp.$1;if("uci"==o)postMessage("id name Rapshort "+version),postMessage("id author Thibor Raven"),postMessage("uciok");else if("isready"==o)postMessage("readyok");else if(/^position (?:(startpos)|fen (.*?))\s*(?:moves\s*(.*))?$/.exec(o)){if(InitializeFromFen("startpos"==RegExp.$1?"":RegExp.$2),RegExp.$3)for(var a=RegExp.$3.split(" "),r=0;r<a.length;r++)MakeMove(GetMoveFromString(a[r]))}else if(/^go /.exec(o)){g_startTime=Date.now();var t=GetNumber(o,/movetime (\d+)/,0),g=GetNumber(o,/depth (\d+)/,0),s=GetNumber(o,/nodes (\d+)/,0);if(!t&&!g&&!s){var n=GetNumber(o,whiteTurn?/wtime (\d+)/:/btime (\d+)/,0),i=GetNumber(o,/movestogo (\d+)/,32);t=Math.floor(n/i)}0<t&&(t-=32)<1&&(t=1),Search(g,t,s)}};